<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>menu</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="icon" type="image/x-icon" href="../img/favicon.ico">
	<link href="https://fonts.cdnfonts.com/css/apercu" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.min.js" integrity="sha384-heAjqF+bCxXpCWLa6Zhcp4fu20XoNIA98ecBC1YkdXhszjoejr5y9Q77hIrv8R9i" crossorigin="anonymous"></script>
	<script type="text/javascript" src="../db/productsList.js"></script>
	<style type="text/css">

		body {
			margin-left: 18px;
			font-family: 'Apercu', sans-serif;
		}


		#logo {
			padding: 1%;
			width: 200px;
		}

		#header input[type=text] {
		    padding: 6px;
		    margin-top: 7%;
		    font-size: 17px;
		    border: 1px solid #ccc;
		    width: 300px;
		}

		#header .search-container button {
			background: #ccc;
			float: right;
			padding: 6px 10px;
			margin-top: 7%;
			margin-right: 10px;
			background: #ddd;
			font-size: 17px;
			border: 1px solid #ccc;
			cursor: pointer;
		}

		#header .search-container {
		    float: right;
		}

		#header .search-container label {
			font-size: 17px;
		}

		#header .checkboxSearch {
            width: 15px;
            height: 15px;
        }

		hr {
			width: 100%;
		}

		#nav {
            list-style: none inside;
            margin: 0 -10px 0 0px;
            padding: 0;
            text-align: center;
        }

        #nav li {
            display: block;
            position: relative;
            float: left;
            background: white;
            font-size: 26px;
			z-index: 1;
        }

        #nav li ul {
        	margin-right: 10px;
        	margin-left: 10px;
        }

        #nav li a {
            display: block;
            padding-left: 10px;
            margin-right: 40px;
            line-height: 35px;
            color: #800080;
        }

        #nav li li a {
            font-size: 18px;
        }

        #nav li:hover {
            background: white;
            font-size: 26px;
        }

        #nav ul {
            position: absolute;
            padding: 0;
            display: none;
            box-shadow: 1px 1px 1px 1px grey;
        }

        #nav li:hover ul ul {
            display: none;
        }

        #nav li:hover ul {
            display: block;
            background: white;
        }

        #nav li li:hover ul {
        	position: relative;
            display: block;
        }

		a {
			text-decoration: none;
		}

		#mainText {
			font: 40px black;
			font-family: 'Apercu', sans-serif;
			text-align: center;
			color: #ff914d;
		}

		label {
			font: 18px black;
		}

		#result {
			text-decoration: none;
  			display: inline-block;
			width: 200px;
			height: 58px;
			border-radius: 15px;
			border-color: #00bf63;
			font-size: 18px;
			text-align: center;
			background: linear-gradient(#00bf63, #c1ff72);
			margin-top: 2%;
		}

		#main {
			display: inline-block;
			width: 100%;
		}

		.container {
			float: left;
			width: 23%;
			margin-right: 2%;
			padding-bottom: 1%;
			border: solid black 2px;
		}

		.dayName, #text {
			font-size: 25px;
		}

		#kkal, #menu {
			border: 2px solid black;
			margin-left: 20px;
		}

		#menuBlock {
			padding-top: 3%;
			padding-bottom: 2%;
		}

		.currentKkal {
			color: #800080;
			font-size: 20px;
		}

	
	</style>
</head>
<body>
<div id="header">
	<img id="logo" src="../img/logo.png" onclick="javascript:location.href='./index.html';">
	<form class="search-container">
		<input type="text" id="search" placeholder="Пошук ..." list="theList" oninput="searchMeal();">
		<button type="submit"><a class="fa fa-search" href="./singlePage.html" onclick="saveSearchResult();"></a></button>
		<div>
			<br>
			<input type="checkbox" id="recipeCheckbox" name="recipeCheckbox" class="checkboxSearch" checked disabled>
			<label for="recipeCheckbox">Пошук по страві</label>
			<input type="checkbox" id="productCheckbox" name="productCheckbox" class="checkboxSearch">
			<label for="productCheckbox">Пошук по інгредіентам</label>
		</div>
	</form>
</div>
<hr>
<ul id="nav">
	<li><a href="./index.html" onclick="saveClickData('Рецепти')">Рецепти</a>
		<ul>
			<li><a href="./index.html" onclick="saveClickData('Сніданок')">Сніданок</a></li>
			<li><a href="./index.html" onclick="saveClickData('Перекус')">Перекус</a></li>
			<li><a href="./index.html" onclick="saveClickData('Обід')">Обід</a>
			<li><a href="./index.html" onclick="saveClickData('Вечеря')">Вечеря</a></li>
			<li><a href="./index.html" onclick="saveClickData('Свято')">Свято</a></li>
		</ul>
	</li>
	<li><a href="./addRecipe.html">Додати рецепт</a></li>
	<li><a href="./calculateKkal.html">Розрахунок калорій</a></li>
	<li><a href="#">Зберегти меню</a></li>
	<li><a href="./saveMenuChildren.html">Зберегти меню для сім'ї</a></li>
	<li><a href="./archiveMenu.html">Архів меню</a></li>
	<li><a href="./archiveFamilyMenu.html">Архів сімейного меню</a></li>

</ul>
<br>
<br>
<hr>
<p id="mainText">Меню для збереження</p>
<div id = "menuBlock">
	<label id="text">Вибрати меню: *</label>
	<select id="menu"></select>
</div>
<div id="main">
	<div class="container">
		<div class="dayName">Понеділок / вівторок</div>
		<div class="breakfast">Сніданок - ...</div>
		<div class="snack">Перекус - ...</div>
		<div class="dinner">Обід - ...</div>
		<div class="supper">Вечеря - ...</div>
		<br>
		<div class="currentKkal"></div>
	</div>
	<div class="container">
		<div class="dayName">Середа / четвер</div>
		<div class="breakfast">Сніданок - ...</div>
		<div class="snack">Перекус - ...</div>
		<div class="dinner">Обід - ...</div>
		<div class="supper">Вечеря - ...</div>
		<br>
		<div class="currentKkal"></div>
	</div>
	<div class="container">
		<div class="dayName">П'ятниця / субота</div>
		<div class="breakfast">Сніданок - ...</div>
		<div class="snack">Перекус - ...</div>
		<div class="dinner">Обід - ...</div>
		<div class="supper">Вечеря - ...</div>
		<br>
		<div class="currentKkal"></div>
	</div>
	<div class="container">
		<div class="dayName">Неділя</div>
		<div class="breakfast">Сніданок - ...</div>
		<div class="snack">Перекус - ...</div>
		<div class="dinner">Обід - ...</div>
		<div class="supper">Вечеря - ...</div>
		<br>
		<div class="currentKkal"></div>
	</div>
</div>
<br>
<br>
<div>
	<label id="text">Ввести кількість калорій на день *</label>
	<input id="kkal" type="text">
</div>
<button id="result" onclick="saveMenu('Alina');">Зберегти меню</button>
<br>

<!-- Confirm modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
			<h5 class="modal-title" id="confirmModalLabel">Меню збережено!</h5>
		  	<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
	  </div>
	</div>
</div>

<script type="text/javascript">
	(() => {
		async function getSavedMenu(url) {
			return (await fetch(url)).json();
		}
		async function getSavedMenuList(url, params) {
			return (await fetch(url)).json();
		} 

		let myModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("confirmModal"));
		myModal.hide();

		async function displayMenus() {
			let savedDataAfter = await getSavedMenu('http://localhost:3000/getSavedMenu').then(async (value) => {
				let num;

				for (let index = value.length-1; index >= 0; index--) {
					let option = document.createElement("option");
					option.className = "menuList";
					let name = new Date(value[index]).toLocaleDateString()
					option.value = value[index];
					option.text = "Меню " + name;
					let currentDiv0 = document.getElementById("menu");
				  	currentDiv0.appendChild(option); 
				}

				await displayMenuDays();
			})
		}

		async function displayMenuDays() {
			let menu = document.getElementById("menu");
			let name = menu.options[menu.selectedIndex].value;

			let savedDataAfter = await getSavedMenu(`http://localhost:3000/getSavedMenuList/menu_${name}.json`).then((value) => {
				let currentKkal = 0;

				for (let i = 0; i < value.length; i++) {
					if(i === 0) {
						dayForMenu = "понеділок/вівторок";
					} else if(i === 1) {
						dayForMenu = "середу/четвер";
					} else if(i === 2) {
						dayForMenu = "п'ятницю/суботу";
					} else if(i === 3) {
						dayForMenu = "неділю";
					}

					let breakfast = document.getElementsByClassName("breakfast");
					let snack = document.getElementsByClassName("snack");
					let dinner = document.getElementsByClassName("dinner");
					let supper = document.getElementsByClassName("supper");

					if(value[i][dayForMenu]["Сніданок"].recipeName) {
						breakfast[i].innerText = "Сніданок - " + value[i][dayForMenu]["Сніданок"].recipeName;
						currentKkal += value[i][dayForMenu]["Сніданок"].totalKkal;
					} else {
						breakfast[i].innerText = "Сніданок - ..."
					}
					if(value[i][dayForMenu]["Перекус"].recipeName) {
						snack[i].innerText = "Перекус - " + value[i][dayForMenu]["Перекус"].recipeName;
						currentKkal += value[i][dayForMenu]["Перекус"].totalKkal;
					} else {
						snack[i].innerText = "Перекус - ...";
					}
					if(value[i][dayForMenu]["Обід"].recipeName) {
						dinner[i].innerText = "Обід - " + value[i][dayForMenu]["Обід"].recipeName;
						currentKkal += value[i][dayForMenu]["Обід"].totalKkal;
					} else {
						dinner[i].innerText = "Обід - ...";
					}
					if(value[i][dayForMenu]["Вечеря"].recipeName) {
						supper[i].innerText = "Вечеря - " + value[i][dayForMenu]["Вечеря"].recipeName;
						currentKkal += value[i][dayForMenu]["Вечеря"].totalKkal;
					} else {
						supper[i].innerText = "Вечеря - ...";
					}

					if(i === 0) {
						document.getElementsByClassName("currentKkal")[0].innerText = "Усього калорій за день: " + currentKkal;
						currentKkal = 0;
					} else if(i === 1) {
						document.getElementsByClassName("currentKkal")[1].innerText = "Усього калорій за день: " + currentKkal;
						currentKkal = 0;
					} else if(i === 2) {
						document.getElementsByClassName("currentKkal")[2].innerText = "Усього калорій за день: " + currentKkal;
						currentKkal = 0;
					} else if(i === 3) {
						document.getElementsByClassName("currentKkal")[3].innerText = "Усього калорій за день: " + currentKkal;
						currentKkal = 0;
					}
				}
			}).catch(err => {
				console.log(err)
			})
		}

		displayMenus();
	})()
	async function getSavedMenu(url) {
		return (await fetch(url)).json();
	}

	// listener for changing chosen menu
	let select = document.getElementById("menu");
	select.addEventListener("change", displayMenuDays, false);

	async function displayMenuDays() {
		let menu = document.getElementById("menu");
		let name = menu.options[menu.selectedIndex].value;

		let savedDataAfter = await getSavedMenu(`http://localhost:3000/getSavedMenuList/menu_${name}.json`).then((value) => {
			let currentKkal = 0;

			for (let i = 0; i < value.length; i++) {
				if(i === 0) {
					dayForMenu = "понеділок/вівторок";
				} else if(i === 1) {
					dayForMenu = "середу/четвер";
				} else if(i === 2) {
					dayForMenu = "п'ятницю/суботу";
				} else if(i === 3) {
					dayForMenu = "неділю";
				}

				let breakfast = document.getElementsByClassName("breakfast");
				let snack = document.getElementsByClassName("snack");
				let dinner = document.getElementsByClassName("dinner");
				let supper = document.getElementsByClassName("supper");

				if(value[i][dayForMenu]["Сніданок"].recipeName) {
					breakfast[i].innerText = "Сніданок - " + value[i][dayForMenu]["Сніданок"].recipeName;
					currentKkal += value[i][dayForMenu]["Сніданок"].totalKkal;
				} else {
					breakfast[i].innerText = "Сніданок - ..."
				}
				if(value[i][dayForMenu]["Перекус"].recipeName) {
					snack[i].innerText = "Перекус - " + value[i][dayForMenu]["Перекус"].recipeName;
					currentKkal += value[i][dayForMenu]["Перекус"].totalKkal;
				} else {
					snack[i].innerText = "Перекус - ...";
				}
				if(value[i][dayForMenu]["Обід"].recipeName) {
					dinner[i].innerText = "Обід - " + value[i][dayForMenu]["Обід"].recipeName;
					currentKkal += value[i][dayForMenu]["Обід"].totalKkal;
				} else {
					dinner[i].innerText = "Обід - ...";
				}
				if(value[i][dayForMenu]["Вечеря"].recipeName) {
					supper[i].innerText = "Вечеря - " + value[i][dayForMenu]["Вечеря"].recipeName;
					currentKkal += value[i][dayForMenu]["Вечеря"].totalKkal;
				} else {
					supper[i].innerText = "Вечеря - ...";
				}

				if(i === 0) {
					document.getElementsByClassName("currentKkal")[0].innerText = "Усього калорій за день: " + currentKkal;
					currentKkal = 0;
				} else if(i === 1) {
					document.getElementsByClassName("currentKkal")[1].innerText = "Усього калорій за день: " + currentKkal;
					currentKkal = 0;
				} else if(i === 2) {
					document.getElementsByClassName("currentKkal")[2].innerText = "Усього калорій за день: " + currentKkal;
					currentKkal = 0;
				} else if(i === 3) {
					document.getElementsByClassName("currentKkal")[3].innerText = "Усього калорій за день: " + currentKkal;
					currentKkal = 0;
				}
			}
		}).catch(err => {
			console.log(err)
		})
	}

	// save menu with calculating kkals
	async function saveMenu(person) {
		let kkal = document.getElementById("kkal").value;
		let menu = document.getElementById("menu");
		let menuSelected = menu.options[menu.selectedIndex].value;
		let totalKkal = [];
		
		let savedDataAfter = await getSavedMenu(`http://localhost:3000/getSavedMenuList/menu_${menuSelected}.json`).then((value) => {
			let val = []; // product list

			for (let i = 0; i < value.length; i++) {
				let kkal = 0;

				if(i === 0) {
					dayForMenu = "понеділок/вівторок";
				} else if(i === 1) {
					dayForMenu = "середу/четвер";
				} else if(i === 2) {
					dayForMenu = "п'ятницю/суботу";
				} else if(i === 3) {
					dayForMenu = "неділю";
				}

				if(value[i][dayForMenu]["Сніданок"].totalKkal) {
					kkal += Number(value[i][dayForMenu]["Сніданок"].totalKkal);
				} 
				if(value[i][dayForMenu]["Перекус"].totalKkal) {
					kkal += Number(value[i][dayForMenu]["Перекус"].totalKkal);
				} 
				if(value[i][dayForMenu]["Обід"].totalKkal) {
					kkal += Number(value[i][dayForMenu]["Обід"].totalKkal);
				} 
				if(value[i][dayForMenu]["Вечеря"].totalKkal) {
					kkal += Number(value[i][dayForMenu]["Вечеря"].totalKkal);
				}

				totalKkal[i] = kkal;
			}

			for (let index = 0; index < totalKkal.length; index++) {
				if(index === 0) {
					dayForMenu = "понеділок/вівторок";
				} else if(index === 1) {
					dayForMenu = "середу/четвер";
				} else if(index === 2) {
					dayForMenu = "п'ятницю/суботу";
				} else if(index === 3) {
					dayForMenu = "неділю";
				}	

				let koef;
				if(kkal > 0) {
					koef = kkal / totalKkal[index]; 
				} else {
					kkal = "без редагування"
					koef = 1;
				}
				
				for (let j = 0; j < 4; j++) {
					let day;
					if(j===0) {
						day = "Сніданок";
					} else if(j===1) {
						day = "Перекус";
					} else if(j===2) {
						day = "Обід";
					} else if(j===3) {
						day = "Вечеря";
					}

					if(value[index][dayForMenu][day].products) {
						for (let i = 0; i < value[index][dayForMenu][day].products.length; i++) {
							if(value[index][dayForMenu][day].products[i].unit !== "шт") {
								value[index][dayForMenu][day].products[i].kkal *= koef;
								value[index][dayForMenu][day].products[i].val *= koef;
							}
							let valList = {}; // save the product list
							let prod = value[index][dayForMenu][day].products[i].prod; 
							valList.prod = value[index][dayForMenu][day].products[i].prod;
							valList.val = value[index][dayForMenu][day].products[i].val;
							valList.unit = value[index][dayForMenu][day].products[i].unit;
							
							if(dayForMenu === "неділю") {
								valList.quantity = 1;
							} else {
								valList.quantity = 2;
							}
							
							val.push(valList);
						}
						value[index][dayForMenu][day].totalKkal *= koef;
					}
				}
			}
			value[0]["понеділок/вівторок"]["menuKkal"] = kkal; // kkal for day
			let menu = document.getElementById("menu");
			let name = menu.options[menu.selectedIndex].value;

			if(person === "Alina") {
				person = "";
			}

			const saveOp = fetch(`http://localhost:3000/updateMenu/menu_${person}${name}.json`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(value),
			});

			if(person !== "Alina") {
				const saveList = fetch(`http://localhost:3000/saveProducrsList/menu_list_${person}${name}.json`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(val),
				});
			}

			let modalConf = bootstrap.Modal.getOrCreateInstance(document.getElementById("confirmModal"));
			modalConf.show();

		}).catch(err => {
			console.log(err)
		})
		
	}

	// method for search field
	function searchProducts() {
		let indexNum;
		let dots = document.getElementsByClassName("searchBar");

		for (let i = 0; i < dots.length; i++) {
			dots[i].addEventListener("input", function() { 
				indexNum = i; // get index of the current product line
			
				if(document.getElementById("character" + indexNum)) { // delete the searched product from the input field and options
					let deleteDiv = document.getElementById("character" + indexNum);
					let parent = deleteDiv.parentNode;
					parent.removeChild(deleteDiv);

					if(document.getElementsByClassName("valuefield")[indexNum]) { // clear the kkal input field and grams input field
						let valueProduct = document.getElementsByClassName("valuefield")[indexNum];
						valueProduct.value = "";
						document.getElementById("products" + indexNum).value = "";
						kkal[indexNum] = 0; // decrease kkal for product
					}
				}

				let newDiv = document.createElement("datalist"); // create new datalist
				newDiv.id = "character" + indexNum;
				newDiv.style = "display: inline-block;";
				let currentDiv;

				if(document.getElementById("products" + indexNum)) {
					currentDiv = document.getElementById("products" + indexNum);
				} else {
					currentDiv = document.getElementsByClassName("products0" + indexNum);
				}
					
				currentDiv.appendChild(newDiv);

				for (let key in productsList) {
					let inputValue = document.getElementsByClassName("searchBar")[indexNum].value;
					inputValue = inputValue.toLowerCase();

					if(productsList[key].name.includes(inputValue) && inputValue !== "" && inputValue !== " ") { // create options with seached products
						let option = document.createElement("option");
						option.className = "options";
						option.value = productsList[key].name;
						let currentDiv0 = document.getElementById("character" + indexNum);
				  		currentDiv0.appendChild(option); 
					}
				}
			});
		}
	}

	async function getData(url) {
		return (await fetch(url)).json();
	}

	function searchMeal() {
		let search = document.getElementById("search");
		localStorage.setItem('recipeName', document.getElementById("search").value);

		if(document.getElementById("theList")) { // delete the searched product from the input field and options
			let deleteDiv = document.getElementById("theList");
			let parent = deleteDiv.parentNode;
			parent.removeChild(deleteDiv);
		}

		async function getDataMenu(url) {
			return (await fetch(url)).json();
		}

		let savedDataAfter = getData('http://localhost:3000/get').then((value) => {
			let newDiv = document.createElement("datalist"); // create new datalist 
			newDiv.id = "theList";
			newDiv.style = "display: inline-block;";
			let currentDiv = document.getElementById("search");
			currentDiv.appendChild(newDiv);
			search = search.value;
			inputValue = search.toLowerCase();
					
			for (let i = 0; i < value.length; i++) {
				let recipeName = value[i].recipeName;

				if(recipeName) {
					let recipeNameLowCase = recipeName.toLowerCase();
								
					if(recipeNameLowCase.includes(inputValue)) { // create options with seached products
						let option = document.createElement("option"); 
						option.className = "liList";
						option.value = recipeName;
						let currentDiv0 = document.getElementById("theList");
						currentDiv0.appendChild(option);
					}
				}	
			}
		})
	}

	async function saveSearchResult() {
		localStorage.setItem('recipeName', document.getElementById("search").value).then(() => {
			window.location.href = "./singlePage.html";
		});
	}

</script>
</body>
</html>